<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" integrity="sha512-wnea99uKIC3TJF7v4eKk4Y+lMz2Mklv18+r4na2Gn1abDRPPOeef95xTzdwGD9e6zXJBteMIhZ1+68QC5byJZw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
        <meta charset="UTF-8">
        <title>Dashboard</title>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="./css/index.css">
  </head>
  <body>
    <div id="form-container">
      <div id="ticketMenu">
      </div>
      <div id="messageArea">
        <div id="messageAreaContainer">
          <div id="titleCard">
            <h1 id="title"></h1>
            <p id="description"></p>
          </div>
          <div id="paddinBox">
            <ul id="messages">
            </ul>
            <input type="text" id="messageBox">
          </div>
        </div>
      </div>
      <div id="rightMenu">
        <div id="right-cont">
          <div id="right-title">
            <h1>Ticket details</h1>
            <button id="refreshMessages" onclick="update()"><img src="./img/reload.svg" alt=""></button>
          </div>
          <div id="flex-row">
            <div style="display: flex; flex-direction: row;">
              <p id="id"></p>
            </div>
            <p id="status"></p>
            <p id="name"></p>
            <p id="tlf"></p>
            <p id="email"></p>
            <p id="date"></p>
          </div>
            <div id="closeTicketDiv">
              <button id="closeTicket" onclick="closeTicket()">
                CLOSE THIS TICKET
              </button>
            </div>
        </div>
    </div>
  </body>
  <script>
    const { ipcRenderer } = require("electron")
    
    var canBeDone = true
    var currentTicket
    var checkIfOpen = []

    document.getElementById("messageBox").addEventListener("keydown", ()=>{
      if (event.keyCode === 13) {
        ipcRenderer.send('sendMessage', {
          id: currentTicket.id, 
          message: document.getElementById("messageBox").value,
          email: currentTicket.from
        })
        document.getElementById("messageBox").value = ""
        refreshMessages()
      }
    })

    ipcRenderer.send('indexLoaded')
    ipcRenderer.on("indexLoadedReply", (e, arg) => {
      setTimeout(function () {
        refreshMessages()
      }, 200)
    })
    ipcRenderer.on("ticketsLoadedReply", (e, arg) => {
      if (!arg) {
        return
      }
      var list = document.createElement("div");
      list.setAttribute('id', 'ticketList')
      list.className = "Ticket"
      list.id = arg.id
      list.innerHTML = "Ticket " + arg.id + ": " + arg.title 
      currentTicket = arg;
      setStatus(currentTicket)
      gotoBottom("messages")
      list.onclick = function () {
        document.getElementById("flex-row").style.display = "flex"
        document.getElementById("messages").innerHTML=""
        ipcRenderer.send('loadMessages', this.id)
        for (let i = 0; i < document.getElementsByClassName("Ticket").length; i++) {
          document.getElementsByClassName("Ticket")[i].className = "Ticket"
        }
        this.className = "Ticket-dark Ticket"
        currentTicket = arg;
        setStatus(currentTicket)
        gotoBottom("messages")
      };
      for (i in arg) {
        let item = document.createElement("div");
        item.classList.add('hidden')
        item.innerHTML = i + ": " + arg[i];
        list.appendChild(item);
      }
        document.getElementById("ticketMenu").appendChild(list);
    })
    ipcRenderer.on("logLoadedReply", (e, arg) => {
      document.getElementById("title").innerText = arg.title
      document.getElementById("description").innerText = arg.description
      if (arg.id == 0) {
        document.getElementById("messages").innerHTML = "<li class='sent'><div class='shown-list'><p>No messages yet</p></div></li>"
        return
      }
      var midSection = document.getElementById("messages")
      let item = document.createElement("li");
      item.classList.add("message")
      if (arg.from.includes("***REMOVED***")) {
        item.style.background = "#F1982FC"
        item.classList.add("sent")
      }else{
        item.classList.add("recieved")
      }
      var tempTime = arg.date.toUTCString().split(' ')[4].split(':')[0][1]
      tempTime = parseInt(tempTime) + 2
      if (arg.date.toUTCString().split(' ')[4].split(':')[0][1] == 0 && tempTime > 24) {
        tempTime = tempTime - 24
        item.innerHTML = '<div class="shown-list ' + arg.id + ' recieved"><h1>' + arg.from + '</h1><h6>' + arg.date.toUTCString().split(',')[0] + ' ' + arg.date.toUTCString().split(' ')[4].split(':')[0][0] + tempTime + ':' + arg.date.toUTCString().split(' ')[4].split(':')[1] + '</h6>' +  '<p>' + arg.message + '</p></div>'
      } else if (arg.date.toUTCString().split(' ')[4].split(':')[0][1] == 0){
        item.innerHTML = '<div class="shown-list ' + arg.id + ' recieved"><h1>' + arg.from + '</h1><h6>' + arg.date.toUTCString().split(',')[0] + ' ' + arg.date.toUTCString().split(' ')[4].split(':')[1][0] + tempTime + ':' + arg.date.toUTCString().split(' ')[4].split(':')[1] + '</h6>' +  '<p>' + arg.message + '</p></div>'
      } else {
        item.innerHTML = '<div class="shown-list ' + arg.id + ' recieved"><h1>' + arg.from + '</h1><h6>' + arg.date.toUTCString().split(',')[0] + ' ' + tempTime + ':' + arg.date.toUTCString().split(' ')[4].split(':')[1] + '</h6>' +  '<p>' + arg.message + '</p></div>'
      }
      document.getElementById("title").innerText = arg.title
      document.getElementById("description").innerText = arg.description
      midSection.appendChild(item);
      checkIfOpen.push(arg.id)
      checkIfOpen.push(arg.elements)
      gotoBottom("messages")
    })

    function update() {
      ipcRenderer.send("reload")
      document.body.innerHTML = ""
      document.body.className = "loading-body"
      let info = document.createElement("h1")
      info.innerText = "Loading..."
      info.className = "info"
      let loading = document.createElement("img")
      loading.src = "./img/loading.png"
      loading.className = "size"
      document.body.appendChild(info)
      document.body.appendChild(loading)
    }
    function refreshMessages() {
        document.getElementById("messages").innerHTML=""
        ipcRenderer.send('loadMessages', currentTicket.id)
    };
    function gotoBottom(id){
      var element = document.getElementById(id);
      element.scrollTop = element.scrollHeight - element.clientHeight;
    }
    function closeTicket() {
      ipcRenderer.send("closeTicket", {id: currentTicket.id, email: currentTicket.from})
      document.getElementById("flex-row").style.display = "none"
      refreshTickets()
      setTimeout(function (){
        document.getElementById("messages").innerHTML = ""
        document.getElementById("title").innerHTML = ""
        document.getElementById("description").innerHTML = ""
      }, 300)
    }
    function refreshTickets() {
      document.getElementById("ticketMenu").innerHTML = ""
    }
    function setStatus(E) {
      document.getElementById("title").innerText = ""
      document.getElementById("description").innerText = ""
      document.getElementById("id").innerText = "ID: " + E.id
      document.getElementById("status").innerText = "Status: " + E.status
      document.getElementById("name").innerText = "Name: " + E.name
      document.getElementById("tlf").innerText = "Tlf number: " + E.phonenum
      document.getElementById("email").innerText = "E-mail: " + E.from
      document.getElementById("date").innerText = "Date: " + E.date.toUTCString().split('GMT')[0]
    }

    setInterval(() => {
      document.getElementById("messages").innerHTML = ""
      ipcRenderer.send("UpdateMessageDB", currentTicket.id)
    }, 10000);
  </script>
</html>
