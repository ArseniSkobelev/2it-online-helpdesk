<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" integrity="sha512-wnea99uKIC3TJF7v4eKk4Y+lMz2Mklv18+r4na2Gn1abDRPPOeef95xTzdwGD9e6zXJBteMIhZ1+68QC5byJZw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
        <meta charset="UTF-8">
        <title>Dashboard</title>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="./css/index.css">
  </head>
  <body>
    <div id="form-container">
      <div id="ticketMenu">
      </div>
      <div id="messageArea">
        <div id="messageAreaContainer">
          <div id="titleCard">
            <h1 id="title"></h1>
            <p id="description"></p>
          </div>
          <div id="paddinBox">
            <ul id="messages">
            </ul>
            <input type="text" id="messageBox">
          </div>
        </div>
      </div>
      <div id="rightMenu">
        <button onclick="Update()">Refresh</button>
        <div class="flex-row">
          <div style="display: flex; flex-direction: row;">
            <h1>Cum: </h1>
            <p id="id"></p>
          </div>
          
          <p id="status"></p>
          <p id="name"></p>
          <p id="tlf"></p>
          <p id="email"></p>
          <p id="date"></p>
        </div>
      </div>
    </div>
  </body>
  <script>
    const { ipcRenderer } = require("electron")

    var currentTicket
    var checkIfOpen = []

    document.getElementById("messageBox").addEventListener("keydown", ()=>{
      if (event.keyCode === 13) {
        ipcRenderer.send('sendMessage', {
          id: currentTicket.id, 
          message: document.getElementById("messageBox").value,
          email: currentTicket.from
        })
        document.getElementById("messageBox").value = ""
        refreshMessages()
      }
    })

    ipcRenderer.send('indexLoaded')
    ipcRenderer.on("indexLoadedReply", (e, arg) => {
      setTimeout(function () {
        refreshMessages()
      }, 100)
    })
    ipcRenderer.on("ticketsLoadedReply", (e, arg) => {
      var list = document.createElement("div");
      list.setAttribute('id', 'ticketList')
      list.className = "Ticket"
      list.id = arg.id
      list.innerHTML = "Ticket " + arg.id + ": " + arg.title 
      currentTicket = arg;
      list.onclick = function () {
        document.getElementById("messages").innerHTML=""
        ipcRenderer.send('loadMessages', this.id)
        for (let i = 0; i < document.getElementsByClassName("Ticket").length; i++) {
          document.getElementsByClassName("Ticket")[i].className = "Ticket"
        }
        this.className = "Ticket-dark Ticket"
        currentTicket = arg;
        document.getElementById("title").innerText = ""
        document.getElementById("description").innerText = ""
        document.getElementById("id").innerText = currentTicket.id
        document.getElementById("status").innerText = currentTicket.status
        document.getElementById("name").innerText = currentTicket.name
        document.getElementById("tlf").innerText = currentTicket.phonenum
        document.getElementById("email").innerText = currentTicket.from
        document.getElementById("date").innerText = currentTicket.date
        gotoBottom("messages")
      };
      for (i in arg) {
        let item = document.createElement("div");
        item.classList.add('hidden')
        item.innerHTML = i + ": " + arg[i];
        list.appendChild(item);
      }
        document.getElementById("ticketMenu").appendChild(list);
    })
    ipcRenderer.on("logLoadedReply", (e, arg) => {
      document.getElementById("title").innerText = arg.title
      document.getElementById("description").innerText = arg.description
      if (arg.id == 0) {
        document.getElementById("messages").innerHTML = "<li class='sent'><div class='shown-list'><p>No messages yet</p></div></li>"
        return
      }
      var midSection = document.getElementById("messages")
      let item = document.createElement("li");
      item.classList.add("message")
      if (arg.from.includes("vg1im.alesundvgs@gmail.com")) {
        item.style.background = "#F1982FC"
        item.classList.add("sent")
      }else{
        item.classList.add("recieved")
      }
      var tempTime = arg.date.toUTCString().split(' ')[4].split(':')[0][1]
      tempTime = parseInt(tempTime) + 2
      if (arg.date.toUTCString().split(' ')[4].split(':')[0][1] == 0 && tempTime > 24) {
        tempTime = tempTime - 24
        item.innerHTML = '<div class="shown-list ' + arg.id + ' recieved"><h1>' + arg.from + '</h1><h6>' + arg.date.toUTCString().split(',')[0] + ' ' + arg.date.toUTCString().split(' ')[4].split(':')[0][0] + tempTime + ':' + arg.date.toUTCString().split(' ')[4].split(':')[1] + '</h6>' +  '<p>' + arg.message + '</p></div>'
      } else if (arg.date.toUTCString().split(' ')[4].split(':')[0][1] == 0){
        item.innerHTML = '<div class="shown-list ' + arg.id + ' recieved"><h1>' + arg.from + '</h1><h6>' + arg.date.toUTCString().split(',')[0] + ' ' + arg.date.toUTCString().split(' ')[4].split(':')[1][0] + tempTime + ':' + arg.date.toUTCString().split(' ')[4].split(':')[1] + '</h6>' +  '<p>' + arg.message + '</p></div>'
      } else {
        item.innerHTML = '<div class="shown-list ' + arg.id + ' recieved"><h1>' + arg.from + '</h1><h6>' + arg.date.toUTCString().split(',')[0] + ' ' + tempTime + ':' + arg.date.toUTCString().split(' ')[4].split(':')[1] + '</h6>' +  '<p>' + arg.message + '</p></div>'
      }
      document.getElementById("title").innerText = arg.title
      document.getElementById("description").innerText = arg.description
      midSection.appendChild(item);
      checkIfOpen.push(arg.id)
      checkIfOpen.push(arg.elements)
      gotoBottom("messages")
    })
    function Update() {
      var xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function () {
        if (xhr.readyState !== 4) return;
        if (xhr.status >= 200 && xhr.status < 300) {
          console.log("success")
        } else {
          console.log("error in refreshing")
        }
        console.log('Request sent');
      };
      xhr.open('POST', 'http://3.16.42.132:3000/update');
      xhr.send();
    }
    function refreshMessages() {
        document.getElementById("messages").innerHTML=""
        ipcRenderer.send('loadMessages', currentTicket.id)
    };
    function gotoBottom(id){
      var element = document.getElementById(id);
      element.scrollTop = element.scrollHeight - element.clientHeight;
    }
  </script>
</html>
